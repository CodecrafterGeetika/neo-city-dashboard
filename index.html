<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Urban Planning Map - Vizag</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
    crossorigin=""/>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      height: 100vh;
    }
    
    /* Ensure layer control is visible */
    .leaflet-control-layers {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .leaflet-control-layers-expanded {
      padding: 10px;
      min-width: 200px;
    }
    
    /* Style the info panel */
    .info-panel {
      padding: 15px;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 250px;
      font-size: 12px;
    }
    
    .info-panel h4 {
      margin: 0 0 10px 0;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
    crossorigin=""></script>

  <script>
    // ====================
    // Map Initialization
    // ====================
    const map = L.map('map').setView([17.6868, 83.2185], 10);

    // ====================
    // Base Layers
    // ====================
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri',
      maxZoom: 19
    });

    const cartoDB = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CartoDB',
      subdomains: 'abcd',
      maxZoom: 20
    });

    const topoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data: &copy; OpenStreetMap, SRTM | Map style: &copy; OpenTopoMap',
      maxZoom: 17
    });

    // ====================
    // Local Data Layers
    // ====================
    const ghsBuilt = L.tileLayer('./tiles_built/{z}/{x}/{y}.png', {
      attribution: '¬© GHS-BUILT / Copernicus',
      maxZoom: 18,
      opacity: 0.7
    });

    const ghsPop = L.tileLayer('./pop/{z}/{x}/{y}.png', {
      attribution: '¬© GHS-POP / Copernicus',
      maxZoom: 18,
      opacity: 0.7
    });

    // ====================
    // Working Overlay Layers
    // ====================
    const terrainLines = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain_lines/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; Stamen Design',
      opacity: 0.6,
      maxZoom: 18
    });

    const hillshade = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
      attribution: 'Hillshading: SRTM3 v2',
      opacity: 0.5,
      maxZoom: 16
    });

    const stamenToner = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner_lines/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; Stamen Design',
      opacity: 0.5,
      maxZoom: 20
    });

    // ====================
    // Zone Analysis Overlay
    // ====================
    const analysisOverlay = L.layerGroup();

    const highDensityZone = L.circle([17.6868, 83.2185], {
      color: 'red',
      fillColor: '#f03',
      fillOpacity: 0.3,
      radius: 2000
    }).bindPopup('<b>High Density Zone</b><br>Population: 12,000+<br>Status: Needs green space');

    const growthZone = L.circle([17.6968, 83.2285], {
      color: 'orange',
      fillColor: '#ff9800',
      fillOpacity: 0.3,
      radius: 1500
    }).bindPopup('<b>Growth Zone</b><br>Population: 9,000<br>Status: Plan infrastructure');

    const balancedZone = L.circle([17.7068, 83.2385], {
      color: 'green',
      fillColor: '#4caf50',
      fillOpacity: 0.3,
      radius: 1200
    }).bindPopup('<b>Balanced Zone</b><br>Population: 5,000<br>Status: Good balance');

    analysisOverlay.addLayer(highDensityZone);
    analysisOverlay.addLayer(growthZone);
    analysisOverlay.addLayer(balancedZone);

    // ====================
    // Layer Control - RADIO BUTTONS + CHECKBOXES
    // ====================
    const baseMaps = {
      "üó∫Ô∏è Street Map": osm,
      "üõ∞Ô∏è Satellite": satellite,
      "üåô Dark Mode": cartoDB,
      "‚õ∞Ô∏è Topographic": topoMap
    };

    const overlayMaps = {
      "üèóÔ∏è GHS-BUILT (Local)": ghsBuilt,
      "üë• GHS-POP (Local)": ghsPop,
      "üìä Zone Analysis": analysisOverlay,
      "üó∫Ô∏è Terrain Lines": terrainLines,
      "‚õ∞Ô∏è Hillshade": hillshade,
      "üé® Toner Lines": stamenToner
    };

    // Add control with expanded view
    L.control.layers(baseMaps, overlayMaps, {
      collapsed: false,
      position: 'topright'
    }).addTo(map);

    // ====================
    // Sample GeoJSON Points
    // ====================
    const sampleGeoJSON = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": { 
            "name": "Ward 1 - City Center", 
            "population": 12000, 
            "built_ratio": 0.6,
            "risk": "high"
          },
          "geometry": { "type": "Point", "coordinates": [83.2185, 17.6868] }
        },
        {
          "type": "Feature",
          "properties": { 
            "name": "Ward 2 - Expansion Zone", 
            "population": 9000, 
            "built_ratio": 0.25,
            "risk": "medium"
          },
          "geometry": { "type": "Point", "coordinates": [83.2285, 17.6968] }
        },
        {
          "type": "Feature",
          "properties": { 
            "name": "Ward 3 - Green Belt", 
            "population": 5000, 
            "built_ratio": 0.2,
            "risk": "low"
          },
          "geometry": { "type": "Point", "coordinates": [83.2385, 17.7068] }
        }
      ]
    };

    // Style markers
    function styleMarker(feature) {
      const p = feature.properties;
      let color = 'green';
      let size = 10;
      let message = '';

      if (p.population > 10000 && p.built_ratio > 0.5) {
        color = '#e74c3c';
        size = 15;
        message = '‚ö†Ô∏è HIGH PRIORITY - Prioritize green infrastructure';
      } else if (p.population > 8000 && p.built_ratio < 0.3) {
        color = '#f39c12';
        size = 12;
        message = '‚ö° GROWTH AREA - Plan infrastructure early';
      } else {
        color = '#27ae60';
        size = 10;
        message = '‚úÖ BALANCED - Maintain current balance';
      }

      return {
        radius: size,
        color: '#fff',
        weight: 2,
        fillColor: color,
        fillOpacity: 0.9,
        popup: `
          <div style="font-family:Arial; min-width:200px;">
            <h3 style="margin:0 0 10px 0; color:${color};">${p.name}</h3>
            <p><b>Population:</b> ${p.population.toLocaleString()}</p>
            <p><b>Built-up Ratio:</b> ${(p.built_ratio * 100).toFixed(0)}%</p>
            <p><b>Status:</b> ${message}</p>
          </div>
        `
      };
    }

    // Add markers
    L.geoJSON(sampleGeoJSON, {
      pointToLayer: function (feature, latlng) {
        const opts = styleMarker(feature);
        return L.circleMarker(latlng, opts).bindPopup(opts.popup);
      }
    }).addTo(map);

    // ====================
    // Info Panel
    // ====================
    const info = L.control({position: 'bottomleft'});

    info.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'info-panel');
      div.innerHTML = `
        <h4>üìä Interactive Map</h4>
        <div style="font-size:11px; line-height:1.5;">
          <b>üéØ How to Use:</b><br>
          ‚Ä¢ Use layer control (top-right) to switch maps<br>
          ‚Ä¢ Check/uncheck overlays<br>
          ‚Ä¢ Click colored circles for zone info<br>
          ‚Ä¢ Click markers for ward details<br><br>
          
          <b>üî¥ Red Zone:</b> High priority<br>
          <b>üü† Orange Zone:</b> Growth area<br>
          <b>üü¢ Green Zone:</b> Balanced<br>
        </div>
      `;
      return div;
    };

    info.addTo(map);

    // Scale control
    L.control.scale({imperial: false, metric: true}).addTo(map);

    // Click for coordinates
    map.on('click', function(e) {
      const lat = e.latlng.lat.toFixed(5);
      const lng = e.latlng.lng.toFixed(5);
      L.popup()
        .setLatLng(e.latlng)
        .setContent(`üìç <b>Coordinates:</b><br>Lat: ${lat}<br>Lng: ${lng}`)
        .openOn(map);
    });

    console.log('‚úÖ Map loaded! Layer controls visible in top-right corner.');
  </script>
</body>
</html>